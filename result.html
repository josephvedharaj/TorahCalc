<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<title>Calculations</title>
</head>
<body>

<h2>TorahCalc</h2>

<div class="table-container">
    <table id="resultTable"></table>
</div>

<div>
    <button id="calcano">Calculate Another Verse ->></button>
</div>
<br>

<script>
document.getElementById('calcano').addEventListener('click', () => {
    window.history.back();
});

const letters = {
    'א':[1,1,1,1], 'ב':[2,2,2,2], 'ג':[3,3,3,3], 'ד':[4,4,4,4],
    'ה':[5,5,5,5], 'ו':[6,6,6,6], 'ז':[7,7,7,7], 'ח':[8,8,8,8],
    'ט':[9,9,9,9], 'י':[10,10,1,1], 'כ':[11,20,2,2], 'ך':[11,20,2,2],
    'ל':[12,30,3,3], 'מ':[13,40,4,4], 'ם':[13,40,4,4], 'נ':[14,50,5,5],
    'ן':[14,50,5,5], 'ס':[15,60,6,6], 'ע':[16,70,7,7], 'פ':[17,80,8,8],
    'ף':[17,80,8,8], 'צ':[18,90,9,9], 'ץ':[18,90,9,9], 'ק':[19,100,10,1],
    'ר':[20,200,2,2], 'ש':[21,300,3,3], 'ת':[22,400,4,4], '׃':[0,0,0,0]
};

function singleDigitSum(n){ return n ? (n%10 + singleDigitSum(Math.floor(n/10))) : 0; }

function cleanInput(text) {
    // keep only Hebrew letters (א-ת), spaces, and remove duplicates
    return text
        .replace(/[^א-ת\s]/g, ' ')    // remove non-Hebrew chars
        .replace(/\s+/g, ' ')         // replace multiple spaces with one
        .trim();                      // remove leading/trailing spaces
}

function calc(words){
    let output = [];
    for(let word of words){
        let temp = [word,0,0,0,0,0,0,0,0,0,0];
        for(let l of word){
            const curr = letters[l] || [0,0,0,0];
            temp[1]+=curr[0]; temp[2]+=curr[1]; temp[7]+=curr[2]; temp[8]+=curr[3];
        }
        let so = singleDigitSum(temp[1]);
        let sco = singleDigitSum(temp[2]);
        temp[3]=so; temp[4]=sco;
        temp[5]=singleDigitSum(so); temp[6]=singleDigitSum(sco);
        temp[9]=singleDigitSum(temp[7]); temp[10]=singleDigitSum(temp[8]);
        output.push(temp);
    }
    return output;
}

function totcalc(output, rawverse){
    let total = [0, rawverse,0,0,0,0,0,0,0,0,0,0,0]; 
    total[0] = output.length;
    total[12] = rawverse.replace(/\s+/g, '').length; // letter count
    for(let arr of output){
        for(let i=1;i<=10;i++) total[i+1]+=arr[i];
    }
    return total;
}

function findMaleFemale(rawverse) {
    const baseLetters = new Set(['א','ב','ג','ד','ה','ו','ז','ח','ט','י','כ','ל','מ','נ','ס','ע','פ','צ','ק','ר','ש','ת']);
    let maleletters = new Set();
    for (let l of rawverse) {
        if (l === ' ' || l === '׃') continue;
        if (l === 'ך') maleletters.add('כ');
        else if (l === 'ם') maleletters.add('מ');
        else if (l === 'ן') maleletters.add('נ');
        else if (l === 'ף') maleletters.add('פ');
        else if (l === 'ץ') maleletters.add('צ');
        else maleletters.add(l);
    }
    let femaleletters = new Set();
    for (let l of baseLetters) {
        if (!maleletters.has(l)) femaleletters.add(l);
    }
    return [maleletters, femaleletters];
}

// ------------------ Main ------------------
let verseText = sessionStorage.getItem('verseText') || "";
verseText = cleanInput(verseText);  // clean input before processing

const wordsArray = verseText.trim().split(/\s+/);
const output = calc(wordsArray);
const total = totcalc(output, wordsArray.join(' '));
const [maleletters,femaleletters] = findMaleFemale(wordsArray.join(' '));

const table = document.getElementById('resultTable');

// ------------------ Headers ------------------
const headers = [
    'No.', 'Words','Ord Tot','Card Tot','Single of Ord Tot','Single of Card Tot',
    'Single of Single of Ord Tot','Single of Single of Card Tot','Tot of Single of Ord',
    'Tot of Single of Card','Single of Tot of Single of Ord','Single of Tot of Single of Card'
];

const colors = ["#371400", "#800000", "#CC5500", "#CC5500", "#B3B300", "#B3B300", "#006400", "#006400", "#00008B", "#00008B", "#2E0854", "#2E0854", "#4B0082", "#4B0082"];

let tr = document.createElement('tr');
let i = 0;
for(let h of headers){
    let th = document.createElement('th');
    th.innerText = h;
    th.style.backgroundColor = colors[i];
    i++;
    tr.appendChild(th);
}
table.appendChild(tr);

// ------------------ Rows ------------------
output.forEach((arr,i)=>{
    let tr = document.createElement('tr');
    let td1 = document.createElement('td'); td1.innerText = i+1; tr.appendChild(td1);
    for(let val of arr.slice(0,11)) { 
        let td = document.createElement('td'); 
        td.innerText=val; 
        tr.appendChild(td); 
    }
    table.appendChild(tr);
});

// ------------------ Totals ------------------
let trTotalHeader = document.createElement('tr');
trTotalHeader.innerHTML = `<th colspan=12>Total</th>`;
table.appendChild(trTotalHeader);

let trTotalValues = document.createElement('tr');
trTotalValues.innerHTML = `
<td rowspan=2>${total[0]} Words<br><br>${total[12]} Letters</td>
<td rowspan=2>${total[1]}</td>
<td>${total[2]}</td>
<td>${total[3]}</td>
<td>${total[4]}</td>
<td>${total[5]}</td>
<td>${total[6]}</td>
<td>${total[7]}</td>
<td>${total[8]}</td>
<td>${total[9]}</td>
<td>${total[10]}</td>
<td>${total[11]}</td>
`;
table.appendChild(trTotalValues);

let trTotalSum1 = document.createElement('tr');
trTotalSum1.innerHTML = `
<td colspan=2 style="background-color: rgba(255, 127, 0, 0.27)">${total[2]+total[3]}</td>
<td colspan=2 style="background-color: rgba(255, 255, 0, 0.27)">${total[4]+total[5]}</td>
<td colspan=2 style="background-color: rgba(0, 255, 0, 0.27)">${total[6]+total[7]}</td>
<td colspan=2 style="background-color: rgba(0, 0, 255, 0.27)">${total[8]+total[9]}</td>
<td colspan=2 style="background-color: rgba(75, 0, 130, 0.27)">${total[10]+total[11]}</td>
`;
table.appendChild(trTotalSum1);

// ------------------ Male/Female ------------------
const maleArr = Array.from(maleletters);
const femaleArr = Array.from(femaleletters);
const maleOutput = calc([maleArr.join('')]);
const femaleOutput = calc([femaleArr.join('')]);

let trMaleHeader = document.createElement('tr');
trMaleHeader.innerHTML = `<th colspan=12>Male Letters</th>`;
table.appendChild(trMaleHeader);

let trMaleValues = document.createElement('tr');
trMaleValues.innerHTML = `
<td rowspan=2>letters count<br>${maleArr.length}</td>
<td rowspan=2>${maleArr.join(' ')}</td>
<td>${maleOutput[0][1]}</td>
<td>${maleOutput[0][2]}</td>
<td>${maleOutput[0][3]}</td>
<td>${maleOutput[0][4]}</td>
<td>${maleOutput[0][5]}</td>
<td>${maleOutput[0][6]}</td>
<td>${maleOutput[0][7]}</td>
<td>${maleOutput[0][8]}</td>
<td>${maleOutput[0][9]}</td>
<td>${maleOutput[0][10]}</td>
`;
table.appendChild(trMaleValues);

let trMaleSum = document.createElement('tr');
trMaleSum.innerHTML = `
<td colspan=2 style="background-color: rgba(255, 127, 0, 0.27)">${maleOutput[0][1]+maleOutput[0][2]}</td>
<td colspan=2 style="background-color: rgba(255, 255, 0, 0.27)">${maleOutput[0][3]+maleOutput[0][4]}</td>
<td colspan=2 style="background-color: rgba(0, 255, 0, 0.27)">${maleOutput[0][5]+maleOutput[0][6]}</td>
<td colspan=2 style="background-color: rgba(0, 0, 255, 0.27)">${maleOutput[0][7]+maleOutput[0][8]}</td>
<td colspan=2 style="background-color: rgba(75, 0, 130, 0.27)">${maleOutput[0][9]+maleOutput[0][10]}</td>
`;
table.appendChild(trMaleSum);

let trFemaleHeader = document.createElement('tr');
trFemaleHeader.innerHTML = `<th colspan=12>Female Letters</th>`;
table.appendChild(trFemaleHeader);

let trFemaleValues = document.createElement('tr');
trFemaleValues.innerHTML = `
<td rowspan=2>letters count<br>${femaleArr.length}</td>
<td rowspan=2>${femaleArr.join(' ')}</td>
<td>${femaleOutput[0][1]}</td>
<td>${femaleOutput[0][2]}</td>
<td>${femaleOutput[0][3]}</td>
<td>${femaleOutput[0][4]}</td>
<td>${femaleOutput[0][5]}</td>
<td>${femaleOutput[0][6]}</td>
<td>${femaleOutput[0][7]}</td>
<td>${femaleOutput[0][8]}</td>
<td>${femaleOutput[0][9]}</td>
<td>${femaleOutput[0][10]}</td>
`;
table.appendChild(trFemaleValues);

let trFemaleSum = document.createElement('tr');
trFemaleSum.innerHTML = `
<td colspan=2 style="background-color: rgba(255, 127, 0, 0.27)">${femaleOutput[0][1]+femaleOutput[0][2]}</td>
<td colspan=2 style="background-color: rgba(255, 255, 0, 0.27)">${femaleOutput[0][3]+femaleOutput[0][4]}</td>
<td colspan=2 style="background-color: rgba(0, 255, 0, 0.27)">${femaleOutput[0][5]+femaleOutput[0][6]}</td>
<td colspan=2 style="background-color: rgba(0, 0, 255, 0.27)">${femaleOutput[0][7]+femaleOutput[0][8]}</td>
<td colspan=2 style="background-color: rgba(75, 0, 130, 0.27)">${femaleOutput[0][9]+femaleOutput[0][10]}</td>
`;
table.appendChild(trFemaleSum);
</script>
</body>
</html>
